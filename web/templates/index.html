<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #main-content {
            max-width: 600px;
            margin: 0 auto;
        }

        #gpt-response {
            background-color: #f1f1f1;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        #prompt-section p,
        #gpt-response p {
            margin: 0;
            padding: 5px 0;
        }

        .card {
            border: none;
            border-radius: 10px;
        }

        button {
            margin-right: 10px;
        }

        button:last-child {
            margin-right: 0;
        }

        /* 去掉按钮的宽度限制，使按钮一行排列 */
        .btn-group {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        /* 修改 #learning-status 的样式 */
        #learning-status {
            margin-top: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 15px;
            background-color: #f9f9f9;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
            display: none;
        }

        #search-section, #prompt-section, #gpt-response-section {
            margin-top: 20px;
        }

    </style>
</head>
<body>

<!-- Modal -->
<div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="formModalLabel">Personal Knowledge Graph Setup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="user-form">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" value="{{ user_data.username }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="course" class="form-label">Course</label>
                        <input type="text" class="form-control" id="course" value="{{ user_data.course }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="goal" class="form-label">Learning Goal</label>
                        <input type="text" class="form-control" id="goal" value="{{ user_data.goal }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Skill Level</label>
                        <div>
                            <input type="radio" id="beginner" name="level" value="beginner"
                                   {% if user_data.level == 'beginner' %} checked {% endif %} required>
                            <label for="beginner">Beginner</label>
                            <input type="radio" id="intermediate" name="level" value="intermediate"
                                   {% if user_data.level == 'intermediate' %} checked {% endif %}>
                            <label for="intermediate">Intermediate</label>
                            <input type="radio" id="advanced" name="level" value="advanced"
                                   {% if user_data.level == 'advanced' %} checked {% endif %}>
                            <label for="advanced">Advanced</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="skills" class="form-label">Skills acquired</label>
                        <input type="text" class="form-control" id="skills" value="{{ user_data.skills }}" required>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveForm()">Save</button>
            </div>
        </div>
    </div>
</div>
</form>

<!-- 学习状态显示区域 -->
<div id="learning-status" class="card text-center mx-auto mt-4 p-3" style="max-width: 600px;">
    <h5>Learning Status</h5>
    <p id="status-content">Your current learning progress will be displayed here.</p>
</div>
<p></p>

<div id="main-content">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#formModal">
        View/Edit Form
    </button>

    <div id="search-section" class="mt-4">
        <input type="text" id="search-input" class="form-control" placeholder="Enter your learning goal...">
        <button class="btn btn-secondary mt-2" onclick="generatePrompt()">Generate Prompt</button>
    </div>

    <div id="prompt-section" class="card mt-4 p-3" style="display: none;">
        <p>Generated Prompt:</p>
        <p id="generated-prompt" class="bg-light p-2 rounded"></p>
        <button class="btn btn-info" onclick="searchGPT()">Search</button>
    </div>

    <div id="gpt-response-section" class="mt-4" style="display: none;">
        <!-- 使用卡片和对话气泡样式 -->
        <div id="gpt-response" class="card p-3 bg-light"></div>

        <!-- 将按钮放在一行中 -->
        <div class="btn-group mt-3">
            <button class="btn btn-success" onclick="copyText()">Copy</button>
            <button class="btn btn-warning" onclick="regeneratePrompt()">Regenerate</button>
            <button class="btn btn-danger" onclick="handleResponse('bad')">Bad Response</button>
            <button class="btn btn-primary" onclick="handleResponse('good')">Good Response</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>


    // 页面加载时获取并显示学习状态
    document.addEventListener('DOMContentLoaded', function() {
        const username = document.getElementById('username').value; // 假设用户名存储在隐藏字段中
        fetch(`/get_learning_state?username=${username}`)
            .then(response => response.json())
            .then(data => {
                if (data.learning_state) {
                    const learningStatusDiv = document.getElementById('learning-status');
                    learningStatusDiv.style.display = "block"; // 显示学习状态 div
                    learningStatusDiv.innerHTML = `
                    <h3>Current learning status</h3>
                    <p>Course: ${data.learning_state.course}</p>
                    <p>Skill Level: ${data.learning_state.level}</p>
                    <p>Learning Goal: ${data.learning_state.goal}</p>
                    <p>Skills acquired: ${data.learning_state.skills}</p>
                `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    });

    var myModal = new bootstrap.Modal(document.getElementById('formModal'));

    function saveForm() {
        const form = document.getElementById('user-form');
        const fields = [
            { id: 'username', message: 'Please enter your username.' },
            { id: 'course', message: 'Please enter the course name.' },
            { id: 'goal', message: 'Please enter your learning goal.' }
        ];

        let formValid = true;

        fields.forEach(field => {
            const input = document.getElementById(field.id);
            if (input) {
                if (input.value.trim() === '') {
                    input.setCustomValidity(field.message);
                    formValid = false;
                } else {
                    input.setCustomValidity(''); // 清除自定义提示语
                }
            } else {
                console.error(`Element with ID '${field.id}' not found.`);
                formValid = false;
            }
        });

        if (formValid && form.checkValidity()) {
            const formData = {
                username: document.getElementById('username').value.trim(),
                course: document.getElementById('course').value.trim(),
                level: document.querySelector('input[name="level"]:checked').value,
                goal: document.getElementById('goal').value.trim(),
                skills: document.getElementById('skills').value.trim()
            };

            fetch('/save_form', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    myModal.hide(); // 关闭模态框
                    const username = encodeURIComponent(formData.username); // 编码用户名以适应URL
                    window.location.href = `?username=${username}`; // 跳转到包含用户名参数的URL
                });
        } else {
            form.reportValidity(); // 显示自定义提示语
        }
    }

    function showForm() {
        const username = document.getElementById('username').value;
        fetch(`/get_user_data?username=${encodeURIComponent(username)}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('username').value = data.username;
                document.getElementById('course').value = data.course;
                const levelRadioButtons = document.getElementsByName('level');
                levelRadioButtons.forEach(button => {
                    if (button.value === data.level) {
                        button.checked = true;
                    }
                });
                document.getElementById('goal').value = data.goal;
                document.getElementById('skills').value = data.skills;
                document.getElementById('form-modal').style.display = 'block';
                document.getElementById('main-content').style.display = 'none';
            });
    }

    function generatePrompt() {
        const userInput = document.getElementById('search-input').value;
        const username = document.getElementById('username').value;  // 获取username

        // 调用服务器拆分关键词并生成提示
        fetch('/generate_prompt', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                input: userInput,
                username: username  // 将username附加到请求体
            })
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('generated-prompt').innerText = data.prompt;
                document.getElementById('prompt-section').style.display = 'block';
            });
    }


    function searchGPT() {
        const prompt = document.getElementById('generated-prompt').innerText;
        const gptResponseSection = document.getElementById('gpt-response-section');
        gptResponseSection.style.display = 'block';

        fetch('/query_gpt', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ prompt: prompt })
        })
            .then(response => response.json())
            .then(data => {
                const gptResponseDiv = document.getElementById('gpt-response');
                gptResponseDiv.innerText = ''; // 清空以前的内容

                // 分割响应内容（按句号、问号、感叹号）
                const segments = data.response.split(/(?<=[。！？])\s*/);
                let currentIndex = 0;

                function displayNextSegment() {
                    if (currentIndex < segments.length) {
                        const p = document.createElement('p');
                        p.textContent = segments[currentIndex];
                        gptResponseDiv.appendChild(p);
                        currentIndex++;

                        // 每隔1秒显示下一个段落或句子
                        setTimeout(displayNextSegment, 1000);
                    }
                }

                // 启动逐步展示
                displayNextSegment();
            })
            .catch(error => {
                console.error('Error fetching GPT response:', error);
            });
    }

    function handleResponse(type) {
        const prompt = document.getElementById('generated-prompt').innerText;
        const response = document.getElementById('gpt-response').innerText;
        // 处理好/坏响应
        fetch(`/handle_response`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ type, prompt, response })
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
            });
    }
</script>


</body>
</html>