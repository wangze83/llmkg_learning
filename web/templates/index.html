<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">

    <style>
        #main-content {
            max-width: 600px;
            margin: 0 auto;
        }
        #gpt-response-editor h1 {
            font-size: 2em;
            margin-top: 0.67em;
            margin-bottom: 0.67em;
        }

        #gpt-response-editor strong {
            font-weight: bold;
        }

        #gpt-response-editor em {
            font-style: italic;
        }

        #gpt-response-editor ul {
            list-style-type: disc;
            margin-left: 1.5em;
        }


        #gpt-response {
            background-color: #f1f1f1;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        #prompt-section p,
        #gpt-response p {
            margin: 0;
            padding: 5px 0;
        }

        .card {
            border: none;
            border-radius: 10px;
        }

        button {
            margin-right: 10px;
        }

        button:last-child {
            margin-right: 0;
        }

        /* 去掉按钮的宽度限制，使按钮一行排列 */
        .btn-group {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        /* 修改 #learning-status 的样式 */
        #learning-status {
            margin-top: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 15px;
            background-color: #f9f9f9;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
            display: none;
        }

        #search-section, #prompt-section, #gpt-response-section {
            margin-top: 20px;
        }

    </style>
</head>
<body>

<!-- Toast 容器 -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="toast-container"></div>
</div>

<!-- Modal -->
<div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="formModalLabel">Personal Knowledge Graph Setup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="user-form">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" value="{{ user_data.username }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="course" class="form-label">Course</label>
                        <input type="text" class="form-control" id="course" value="{{ user_data.course }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="goal" class="form-label">Learning Goal</label>
                        <input type="text" class="form-control" id="goal" value="{{ user_data.goal }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Skill Level</label>
                        <div>
                            <input type="radio" id="beginner" name="level" value="beginner"
                                   {% if user_data.level == 'beginner' %} checked {% endif %} required>
                            <label for="beginner">Beginner</label>
                            <input type="radio" id="intermediate" name="level" value="intermediate"
                                   {% if user_data.level == 'intermediate' %} checked {% endif %}>
                            <label for="intermediate">Intermediate</label>
                            <input type="radio" id="advanced" name="level" value="advanced"
                                   {% if user_data.level == 'advanced' %} checked {% endif %}>
                            <label for="advanced">Advanced</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="skills" class="form-label">Skills acquired</label>
                        <input type="text" class="form-control" id="skills" value="{{ user_data.skills }}" required>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveForm()">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 学习状态显示区域 -->
<div id="learning-status" class="card text-center mx-auto mt-4 p-3" style="max-width: 600px;">
    <h5>Learning Status</h5>
    <p id="status-content">Your current learning progress will be displayed here.</p>
</div>
<p></p>

<div id="main-content">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#formModal">
        View/Edit Form
    </button>

    <div id="search-section" class="mt-4">
        <input type="text" id="search-input" class="form-control" placeholder="Enter your learning goal...">
        <button class="btn btn-secondary mt-2" onclick="generatePrompt()">Generate Prompt</button>
    </div>

    <div id="prompt-section" class="card mt-4 p-3" style="display: none;">
        <p>Generated Prompt:</p>
        <p id="generated-prompt" class="bg-light p-2 rounded"></p>
        <button class="btn btn-info" onclick="searchGPT()">Search</button>
    </div>

    <div id="gpt-response-section" class="mt-4">
        <!-- 使用卡片和对话气泡样式 -->
        <textarea id="gpt-response-editor" class="card p-3 bg-light">
            Creating a learning path for Natural Language Processing (NLP) involves a structured approach to understanding both the foundational concepts of computer science and the specific techniques and tools used in NLP. Since you mentioned having an intermediate level understanding in computer science (CS1), I’ll provide a comprehensive learning path that builds on that knowledge. ### **Learning Path for Natural Language Processing (NLP)** #### **1. Strengthen Your Foundations** - **Programming Skills:** - **Python:** Learn essential Python libraries for data manipulation (NumPy, pandas) and visualization (Matplotlib, Seaborn). - **Data Structures & Algorithms:** - Understand basic data structures (lists, queues, stacks, trees) and algorithms (sorting, searching). - **Mathematics:** - Brush up on linear algebra, probability, and statistics, as they are fundamental in NLP. #### **2. Get Acquainted with Text Processing** - **Text Preprocessing Techniques:** - Learn about tokenization, stemming, lemmatization, stopword removal, and text normalization. - **Regular Expressions:** - Practice using regular expressions for pattern matching and text manipulation.
        </textarea>

        <!-- 将按钮放在一行中 -->
        <div class="btn-group mt-3">
            <button class="btn btn-success" onclick="copyText()">Copy</button>
            <button class="btn btn-warning" onclick="regeneratePrompt()">Regenerate</button>
            <button class="btn btn-danger" onclick="handleResponse('bad')">Bad Response</button>
            <button class="btn btn-primary" onclick="handleResponse('good')">Good Response</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>



<script>
    function copyText() {
        const textArea = document.getElementById('gpt-response-editor');
        textArea.select();
        document.execCommand('copy');
        showToast('Text copied to clipboard!', 'success');
    }

    const easyMDE = new EasyMDE({
        element: document.getElementById('gpt-response-editor'),
        renderingConfig: {
            singleLineBreaks: true,
            codeSyntaxHighlighting: true,
        },
        minHeight: "300px",
        maxHeight: "500px",
        status: false,
    });

    // 通用函数显示 Toast
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container');
        const toastId = 'toast-' + Date.now();
        const toastHTML = `
            <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        toastContainer.innerHTML += toastHTML;
        const toastElement = new bootstrap.Toast(document.getElementById(toastId));
        toastElement.show();

        // 自动在3秒后隐藏
        setTimeout(() => {
            toastElement.hide();
        }, 3000);
    }

    // 页面加载时获取并显示学习状态
    document.addEventListener('DOMContentLoaded', function() {
        const username = document.getElementById('username').value; // 假设用户名存储在隐藏字段中
        fetch(`/get_learning_state?username=${username}`)
            .then(response => response.json())
            .then(data => {
                if (data.learning_state) {
                    const learningStatusDiv = document.getElementById('learning-status');
                    learningStatusDiv.style.display = "block"; // 显示学习状态 div
                    learningStatusDiv.innerHTML = `
                    <h3>Current learning status</h3>
                    <p>Course: ${data.learning_state.course}</p>
                    <p>Skill Level: ${data.learning_state.level}</p>
                    <p>Learning Goal: ${data.learning_state.goal}</p>
                    <p>Skills acquired: ${data.learning_state.skills}</p>
                `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    });

    var myModal = new bootstrap.Modal(document.getElementById('formModal'));

    function saveForm() {
        const form = document.getElementById('user-form');
        const fields = [
            { id: 'username', message: 'Please enter your username.' },
            { id: 'course', message: 'Please enter the course name.' },
            { id: 'goal', message: 'Please enter your learning goal.' }
        ];

        let formValid = true;

        fields.forEach(field => {
            const input = document.getElementById(field.id);
            if (input) {
                if (input.value.trim() === '') {
                    input.setCustomValidity(field.message);
                    formValid = false;
                } else {
                    input.setCustomValidity(''); // 清除自定义提示语
                }
            } else {
                console.error(`Element with ID '${field.id}' not found.`);
                formValid = false;
            }
        });

        if (formValid && form.checkValidity()) {
            const formData = {
                username: document.getElementById('username').value.trim(),
                course: document.getElementById('course').value.trim(),
                level: document.querySelector('input[name="level"]:checked').value,
                goal: document.getElementById('goal').value.trim(),
                skills: document.getElementById('skills').value.trim()
            };

            fetch('/save_form', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    showToast(data.message, 'success');
                    myModal.hide(); // 关闭模态框
                    const username = encodeURIComponent(formData.username); // 编码用户名以适应URL
                    window.location.href = `?username=${username}`; // 跳转到包含用户名参数的URL
                });
        } else {
            form.reportValidity(); // 显示自定义提示语
        }
    }

    function showForm() {
        const username = document.getElementById('username').value;
        fetch(`/get_user_data?username=${encodeURIComponent(username)}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('username').value = data.username;
                document.getElementById('course').value = data.course;
                const levelRadioButtons = document.getElementsByName('level');
                levelRadioButtons.forEach(button => {
                    if (button.value === data.level) {
                        button.checked = true;
                    }
                });
                document.getElementById('goal').value = data.goal;
                document.getElementById('skills').value = data.skills;
                document.getElementById('form-modal').style.display = 'block';
                document.getElementById('main-content').style.display = 'none';
            });
    }

    function generatePrompt() {
        const userInput = document.getElementById('search-input').value;
        const username = document.getElementById('username').value;  // 获取username

        // 调用服务器拆分关键词并生成提示
        fetch('/generate_prompt', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                input: userInput,
                username: username  // 将username附加到请求体
            })
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('generated-prompt').innerText = data.prompt;
                document.getElementById('prompt-section').style.display = 'block';
            });
    }


    function searchGPT() {
        const prompt = document.getElementById('generated-prompt').innerText;
        const gptResponseSection = document.getElementById('gpt-response-section');
        gptResponseSection.style.display = 'block';

        fetch('/query_gpt', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ prompt: prompt })
        })
            .then(response => response.json())
            .then(data => {
                const gptResponseDiv = document.getElementById('gpt-response-editor');
                gptResponseDiv.innerText = ''; // 清空以前的内容

                // 分割响应内容（按句号、问号、感叹号）
                const segments = data.response.split(/(?<=[。！？])\s*/);
                let currentIndex = 0;

                function displayNextSegment() {
                    if (currentIndex < segments.length) {
                        const p = document.createElement('p');
                        p.textContent = segments[currentIndex];
                        gptResponseDiv.appendChild(p);
                        currentIndex++;

                        // 每隔1秒显示下一个段落或句子
                        setTimeout(displayNextSegment, 1000);
                    }
                }

                // 启动逐步展示
                displayNextSegment();
            })
            .catch(error => {
                console.error('Error fetching GPT response:', error);
            });
    }

    function handleResponse(type) {
        if(type === "bad") {
            showToast('Feedback received. Please try to regenerate Or We will try to improve the model later.', 'warning');
        } else {

            // 获取页面上的prompt和response值
            const prompt = document.getElementById('search-input').value;
            const response = easyMDE.value();  // 获取GPT响应内容（markdown编辑器中的内容）

            // 处理好响应
            fetch(`/handle_response`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({type, prompt, response})
            })
                .then(response => response.json())
                .then(data => {
                    showToast(data.message, 'success');
                });
        }
    }

    function regeneratePrompt(){
        searchGPT()
    }

</script>

</body>
</html>